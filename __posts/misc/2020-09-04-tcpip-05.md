---
layout: post
title: "TCP/IP详解notes:05传输控制协议"
category: Misc
tags: TCP/IP notes
keywords: "传输控制协议TCP"
description: "传输控制协议TCP"
coverage: tcpip_flow_control.jpg
permalink: /misc/:title
date: 2017-09-29T02:00:00+08:00
---

## 1. TCP通过下列方式来提供可靠性

1. 应用数据被`分割成TCP认为最适合发送的数据块`.这和UDP完全不同，`UDP应用程序产生的数据报长度将保持不变`.由TCP传递给IP的信息单位称为报文段或段（segment）（参见图1-7）.
2. 当TCP发出一个段后，它启动一个`定时器`，等待目的端确认收到这个报文段.如果`不能及时收到一个确认`，将`重发`这个报文段.
3. 当TCP`收到`发自TCP连接另一端的数据，它将发送一个`确认`.这个确认不是立即发送，通常将`推迟几分之一秒`，这将在19.3节讨论.
4. TCP将保持它首部和数据的`检验和`.这是一个`端到端的检验和`，目的是`检测数据`在传输过程中的任何`变化`.如果收到段的`检验和`有差错，TCP将`丢弃`这个报文段和`不确认收到此报文段`
   （希望发端超时并重发）.
5. 既然`TCP报文段`作为`IP数据报`来传输，而`IP数据报`的到达`可能会失序`，因此`TCP报文段`的到达也`可能会失序`.如果必要，`TCP将对收到的数据进行重新排序`
   ，将收到的数据以`正确的顺序交给应用层`.
6. 既然IP数据报会发生重复，`TCP的接收端`必须`丢弃重复`的数据.
7. TCP还能提供`流量控制`.TCP连接的每一方都有`固定大小的缓冲空间`.TCP的接收端只允许另一端发送`接收端缓冲区所能接纳的数据`.这将防止较快主机致使较慢主机的缓冲区溢出.

两个应用程序通过TCP连接交换8bit字节构成的字节流.
TCP不在字节流中插入记录标识符.我们将这称为`字节流服务`（byte stream service）.如果一方的应用程序先传10字节，又传20字节，再传50字节，连接的另一方将无法了解发方每次发送了多少字节.
收方可以分4次接收这80个字节，每次接收20字节.一端将字节流放到TCP连接上，同样的字节流将出现在TCP连接的另一端.

另外，TCP对字节流的内容不作任何解释.TCP不知道传输的数据字节流是二进制数据，还是ASCII字符、EBCDIC字符或者其他类型数据.对`字节流`的解释`由TCP连接双方的应用层解释`.

## 2. 图解

TCP数据被封装在一个IP数据报中
![](/assets/image/tcp_17_1.png)

TCP首部的数据格式.如果不计任选字段，它通常是20个字节.
![](/assets/image/tcp_17_2.png)

- Socket: 一个IP地址和一个端口号也称为一个插口（socket）
- 插口对（SocketPair）(包含客户IP地址、客户端口号、服务器IP地址和服务器端口号的四元组)可唯一确定互联网络中每个TCP连接的双方.

## 3. 字节传输

`序号`用来标识从TCP发端向TCP收端发送的数据字节流，它表示在这个`报文段`中的`第一个数据字节`.如果将`字节流`看作在两个应用程序间的单向流动，
则TCP用`序号`对每个字节进行`计数`.序号是32 bit的无符号数，序号到达232－1后又从0开始.

当建立一个新的连接时，SYN标志变1.序号字段包含由这个主机选择的该连接的初始序号ISN（Initial Sequence Number）.
该主机要发送数据的第一个字节序号为这个ISN加1，因为SYN标志消耗了一个序号（将在下章详细介绍如何建立和终止连接，届时我们将看到FIN标志也要占用一个序号）.

既然每个传输的字节都被计数，确认序号包含发送确认的一端所期望收到的下一个序号.因此，确认序号应当是上次已成功收到数据字节序号加1.只有ACK标志（下面介绍）为1时确认序号字段才有效.

发送ACK无需任何代价，因为32 bit的确认序号字段和ACK标志一样，总是TCP首部的一部分.因此，我们看到一旦一个连接建立起来，这个字段总是被设置，ACK标志也总是被设置为1.

TCP为应用层提供全双工服务.这意味数据能在两个方向上独立地进行传输.因此，连接的每一端必须保持每个方向上的传输数据序号.

TCP可以表述为一个`没有选择确认或否认`的`滑动窗口协议`（滑动窗口协议用于数据传输将在20.3节介绍）.
我们说TCP缺少选择确认是因为TCP首部中的确认序号表示发方已成功收到字节，但还不包含确认序号所指的字节.当前还无法对数据流中选定的部分进行确认.
例如，如果1～1024字节已经成功收到，下一报文段中包含序号从2049～3072的字节，收端并不能确认这个新的报文段.它所能做的就是发回一个确认序号为1025的ACK.它也无法对一个报文段进行否认.
例如，如果收到包含1025～2048字节的报文段，但它的检验和错，TCP接收端所能做的就是发回一个确认序号为1025的ACK.在21.7节我们将看到重复的确认如何帮助确定分组已经丢失.

首部长度给出首部中32 bit字的数目.需要这个值是因为任选字段的长度是可变的.这个字段占4bit，因此TCP最多有60字节的首部.然而，没有任选字段，正常的长度是20字节.
在TCP首部中有6个标志比特.它们中的多个可同时被设置为1.我们在这儿简单介绍它们的用法，在随后的章节中有更详细的介绍.

![](/assets/image/tcp_17_3.png)

`TCP的流量控制由连接的每一端通过声明的窗口大小来提供`.`窗口大小为字节数`，起始于确认序号字段指明的值，这个值是接收端正期望接收的字节.窗口大小是一个16 bit字段，因而窗口大小最大为65535字节.
在24.4节我们将看到新的窗口刻度选项，它允许这个值按比例变化以提供更大的窗口.

`检验和`覆盖了整个的TCP报文段：TCP首部和TCP数据.这是一个强制性的字段，一定是由发端计算和存储，并由收端进行验证.`TCP检验和`的计算和UDP检验和的计算相似.

只有当URG标志置1时紧急指针才有效.`紧急指针是一个正的偏移量`，和序号字段中的值相加表示紧急数据最后一个字节的序号.TCP的紧急方式是发送端向另一端发送紧急数据的一种方式.

最常见的可选字段是最长报文大小，又称为MSS(Maximum Segment Size).每个连接方通常都在通信的第一个报文段（为建立连接而设置SYN标志的那个段）中指明这个选项.
它指明本端所能接收的最大长度的报文段.

`TCP报文段`中的数据部分是`可选的`.有时候双方交换的报文段仅有TCP首部.如果一方没有数据要发送，也使用`没有任何数据的首部`来确认收到的数据.在`处理超时`
的许多情况中，`也会发送不带任何数据的报文段`.